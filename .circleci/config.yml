# TODO: Use caching
version: 2
jobs:
    lint:
        docker:
            - image: circleci/python:3.6
        steps:
            - checkout
            - run:
                  command: |
                      sudo apt-get update && sudo apt-get install -y --no-install-recommends libpython3.5-dev python3.5-dev
                      sudo pip install poetry
                      poetry config settings.virtualenvs.create false
                      sudo pip install tox
            - run: tox -e lint
    test:
        docker:
            - image: circleci/python:3.6
        steps:
            - checkout
            - run:
                  command: |
                      sudo apt-get update && sudo apt-get install -y --no-install-recommends libpython3.5-dev python3.5-dev
                      sudo pip install poetry
                      poetry config settings.virtualenvs.create false
                      sudo pip install tox
            - run: tox -e py
#            - store_test_results:
#                  path: test-results
#            - store_artifacts:
#                  path: test-results
#                  destination: tr1
            - store_artifacts:
                  path: htmlcov
                  destination: coverage
                  prefix: coverage
    pages:
        docker:
            - image: circleci/python:3.6
        steps:
            - add_ssh_keys:
                  fingerprints:
                      - "f3:65:88:37:1e:8d:9b:dc:22:40:9f:c2:2d:1c:a4:36"
            - checkout
            - run:
                  command: |
                      sudo apt-get update && sudo apt-get install -y --no-install-recommends libpython3.5-dev python3.5-dev openssh-client
                      sudo ssh-keyscan github.com >> ~/.ssh/known_hosts
                      sudo chmod 644 ~/.ssh/known_hosts
                      git clone --branch gh-pages git@github.com:Unbabel/OpenKiwi.git gh-pages
                      tox -e gh-pages
                      git config --global user.email "openkiwi@unbabel.com"
                      git config --global user.name "GitLab CI"
                      lasttag=`git rev-parse --short HEAD`; cd gh-pages; git add .; git commit -m "Update docs for $lasttag"
                      git push git@github.com:Unbabel/OpenKiwi.git gh-pages

workflows:
    version: 2
    workflow:
        jobs:
            - lint
            - test
            - pages:
                  requires:
                      - lint
                      - test
                  filters:
                      branches:
                          only: master
